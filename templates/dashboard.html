{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12 text-center mb-4">
            <h1>Panel U≈ºytkownika: {{ user.username }}</h1>
            <p class="text-muted">ZarzƒÖdzaj swoim portfelem. Wykres Bitcoina jest LIVE.</p>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="input-group shadow-sm">
                <input type="text" id="cryptoInput" class="form-control" placeholder="ID waluty (np. ripple, litecoin, cardano)">
                <button class="btn btn-primary" onclick="addCrypto()">Obserwuj +</button>
            </div>
            <small class="text-muted ps-2">Wpisuj pe≈Çne nazwy z CoinGecko (np. 'binancecoin' a nie 'BNB').</small>
        </div>
    </div>

    <div class="row" id="crypto-container">
        {% for crypto in favorites %}
        <div class="col-md-4 mb-3" id="card-{{ crypto.symbol }}">
            <div class="card shadow-sm border-secondary">
                <div class="card-body text-center">
                    <h3 class="card-title text-uppercase">{{ crypto.symbol }}</h3>
                    
                    <h2 class="display-6 fw-bold price-tag" 
                        data-symbol="{{ crypto.symbol }}" 
                        id="price-{{ crypto.symbol }}">
                        ≈Åadowanie...
                    </h2>
                    
                    <button class="btn btn-sm btn-outline-danger mt-3" onclick="removeCrypto({{ crypto.id }} , '{{ crypto.symbol }}')">Usu≈Ñ z obserwowanych</button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center text-muted">
            <p>Tw√≥j portfel jest pusty. Dodaj pierwszƒÖ kryptowalutƒô powy≈ºej!</p>
        </div>
        {% endfor %}
    </div>

    <div class="row mt-5">
        <div class="col-md-12">
            <div class="card p-2 shadow-sm">
                <div class="d-flex justify-content-between align-items-center ps-3 pe-3 pt-2 pb-2">
                    <h4 id="chart-title">Bitcoin (USD) - LIVE üî¥</h4>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger btn-sm" id="btn-live" onclick="switchToLive()">LIVE ‚ö°</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeInterval(30, '30 Dni')">30D</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeInterval(365, '1 Rok')">1Y</button>
                    </div>
                </div>
                
                <div id="tv-chart" style="width: 100%; height: 500px;"></div>
                <div class="text-end pe-2 text-muted small">Dane live: Binance WebSocket | Historia: CoinGecko</div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // ==========================================
    // CZƒò≈öƒÜ 1: OBS≈ÅUGA DASHBOARDU (Dodawanie/Usuwanie)
    // ==========================================

    function addCrypto() {
        const input = document.getElementById('cryptoInput');
        const symbol = input.value.trim();

        if (!symbol) return;

        // Blokada przycisku na chwilƒô
        input.disabled = true;

        fetch('/api/add_crypto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ symbol: symbol })
        })
        .then(res => res.json())
        .then(data => {
            if (data.message === 'Dodano') {
                location.reload(); 
            } else {
                alert("B≈ÇƒÖd: " + (data.message || "Nieznany b≈ÇƒÖd"));
                input.disabled = false;
            }
        })
        .catch(err => {
            alert("B≈ÇƒÖd po≈ÇƒÖczenia z serwerem");
            input.disabled = false;
        });
    }

    function removeCrypto(id, symbol) {
        if(!confirm("Czy na pewno chcesz usunƒÖƒá " + symbol + "?")) return;

        fetch('/api/delete_crypto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: id })
        })
        .then(res => res.json())
        .then(data => {
            // Usuwamy kafelek bez prze≈Çadowania strony (AJAX)
            const card = document.getElementById('card-' + symbol);
            if(card) card.remove();
        });
    }

    // ==========================================
    // CZƒò≈öƒÜ 2: WYKRES I CENY (Logika z Index.html)
    // ==========================================
    
    const chartContainer = document.getElementById('tv-chart');
    const chartTitle = document.getElementById('chart-title');
    let chartCache = {}; 
    let ws = null; 

    // Konfiguracja TradingView
    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 500,
        layout: { background: { color: 'transparent' }, textColor: '#888' },
        grid: { vertLines: { color: '#444', visible: false }, horzLines: { color: '#444', visible: true } },
        timeScale: { timeVisible: true, secondsVisible: true },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });

    const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    // --- Funkcja LIVE (Binance) ---
    async function switchToLive() {
        document.getElementById('btn-live').className = "btn btn-danger btn-sm";
        chartTitle.innerText = "Bitcoin (USD) - REAL TIME (1m) ‚ö°";
        document.querySelectorAll('.btn-group .btn-outline-secondary').forEach(btn => btn.classList.remove('active'));

        try {
            // Pobieramy t≈Ço (historiƒô)
            const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=1000');
            const data = await response.json();
            const formattedData = data.map(item => ({
                time: item[0] / 1000,
                open: parseFloat(item[1]), high: parseFloat(item[2]), low: parseFloat(item[3]), close: parseFloat(item[4])
            }));
            candleSeries.setData(formattedData);
        } catch (error) { console.error(error); }

        // Odpalamy WebSocket
        if (ws) ws.close();
        ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const kline = message.k;
            const candle = {
                time: kline.t / 1000,
                open: parseFloat(kline.o), high: parseFloat(kline.h), low: parseFloat(kline.l), close: parseFloat(kline.c)
            };
            candleSeries.update(candle);

            // Aktualizujemy kafelek Bitcoina (je≈õli u≈ºytkownik go ma w ulubionych!)
            const btcTag = document.getElementById('price-bitcoin');
            if (btcTag) {
                btcTag.innerText = parseFloat(kline.c).toFixed(2) + " $";
                btcTag.style.color = candle.close >= candle.open ? "#28a745" : "#dc3545";
            }
        };
        chart.timeScale().scrollToPosition(5, true);
    }

    // --- Funkcja HISTORIA (CoinGecko) ---
    async function changeInterval(days, title) {
        if (ws) { ws.close(); ws = null; }
        document.getElementById('btn-live').className = "btn btn-outline-danger btn-sm";
        chartTitle.innerText = `Bitcoin (USD) - ${title}`;

        if (chartCache[days]) {
            candleSeries.setData(chartCache[days]);
            chart.timeScale().fitContent();
            return;
        }

        try {
            const response = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/ohlc?vs_currency=usd&days=${days}`);
            if (response.status === 429) { alert("Limit CoinGecko! Czekaj."); return; }
            const data = await response.json();
            const formattedData = data.map(item => ({
                time: item[0] / 1000,
                open: item[1], high: item[2], low: item[3], close: item[4]
            }));
            chartCache[days] = formattedData;
            candleSeries.setData(formattedData);
            chart.timeScale().fitContent();
        } catch (error) { console.error(error); }
    }

    // --- Aktualizacja cen Innych Walut ---
    function fetchOtherPrices() {
        const priceTags = document.querySelectorAll('.price-tag');
        let symbols = [];
        priceTags.forEach(tag => {
            // Bitcoina nie pobieramy z CoinGecko, bo mamy go z WebSocketa (Binance)
            if (tag.dataset.symbol.toLowerCase() !== 'bitcoin') {
                symbols.push(tag.dataset.symbol.toLowerCase());
            }
        });

        if (symbols.length === 0) return;

        fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbols.join(',')}&vs_currencies=usd`)
            .then(res => res.json())
            .then(data => {
                priceTags.forEach(tag => {
                    const s = tag.dataset.symbol.toLowerCase(); 
                    if (data[s]) tag.innerText = data[s].usd + " $";
                });
            }).catch(e => {});
    }

    // START
    window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth }));
    
    switchToLive();
    
    // Inne waluty co 20 sekund (≈ºeby nie zabiƒá limitu Dashboardu)
    setInterval(fetchOtherPrices, 20000);
    fetchOtherPrices();

</script>
{% endblock %}