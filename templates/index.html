{% extends "base.html" %}

{% block content %}
<div class="container mt-5 text-center">
    <h1 class="display-4">Witamy na Gie≈Çdzie! üìà</h1>
    <p class="lead">Zaloguj siƒô, aby stworzyƒá w≈Çasny portfel obserwowanych.</p>
    <hr class="my-4">

    <div class="row justify-content-center" id="crypto-container">
        {% for crypto in favorites %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h4 class="text-uppercase">{{ crypto.symbol }}</h4>
                    <h3 class="price-tag text-primary" data-symbol="{{ crypto.symbol }}" id="price-{{ crypto.symbol }}">≈Åadowanie...</h3>
                </div>
            </div>
        </div>
        {% else %}
            <p>Admin jeszcze nie ustawi≈Ç walut na stronie g≈Ç√≥wnej.</p>
        {% endfor %}
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card p-2 shadow-sm">
                <div class="d-flex justify-content-between align-items-center ps-3 pe-3 pt-2 pb-2">
                    <h4 id="chart-title">Bitcoin (USD) - LIVE üî¥</h4>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger btn-sm" id="btn-live" onclick="switchToLive()">LIVE ‚ö°</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeInterval(30, '30 Dni')">30D</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeInterval(365, '1 Rok')">1Y</button>
                    </div>
                </div>
                
                <div id="tv-chart" style="width: 100%; height: 500px;"></div>
                <div class="text-end pe-2 text-muted small">Dane live: Binance WebSocket | Historia: CoinGecko</div>
            </div>
        </div>
    </div>  
</div>
<script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // ==========================================
    // KONFIGURACJA WYKRESU
    // ==========================================
    const chartContainer = document.getElementById('tv-chart');
    const chartTitle = document.getElementById('chart-title');
    
    // Cache trzymamy osobno dla Binance i CoinGecko
    let chartCache = {}; 
    let ws = null; 

    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 500,
        layout: { background: { color: 'transparent' }, textColor: '#888' },
        grid: { vertLines: { color: '#444', visible: false }, horzLines: { color: '#444', visible: true } },
        timeScale: { timeVisible: true, secondsVisible: true },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });

    const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    // ==========================================
    // 1. TRYB LIVE (BINANCE: Historia 1m + WebSocket)
    // ==========================================
    async function switchToLive() {
        // Zmiana UI
        document.getElementById('btn-live').className = "btn btn-danger btn-sm";
        chartTitle.innerText = "Bitcoin (USD) - REAL TIME (1m) ‚ö°";

        // Resetujemy przyciski "d≈Çugoterminowe" na szare
        document.querySelectorAll('.btn-group .btn-outline-secondary').forEach(btn => btn.classList.remove('active'));

        // A. Pobieramy historiƒô 1-minutowƒÖ z Binance REST API
        // (Binance pozwala na 1000 ≈õwieczek wstecz = ok. 16 godzin historii 1-minutowej)
        try {
            console.log("Pobieram historiƒô 1m z Binance...");
            const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=1000');
            const data = await response.json();

            // Format Binance: [Time, Open, High, Low, Close, Volume...]
            const formattedData = data.map(item => ({
                time: item[0] / 1000,
                open: parseFloat(item[1]),
                high: parseFloat(item[2]),
                low: parseFloat(item[3]),
                close: parseFloat(item[4])
            }));

            candleSeries.setData(formattedData);
            
        } catch (error) {
            console.error("B≈ÇƒÖd historii Binance:", error);
        }

        // B. Pod≈ÇƒÖczamy WebSocket (dane na bie≈ºƒÖco)
        if (ws) ws.close();
        ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const kline = message.k;
            
            const candle = {
                time: kline.t / 1000,
                open: parseFloat(kline.o),
                high: parseFloat(kline.h),
                low: parseFloat(kline.l),
                close: parseFloat(kline.c)
            };

            candleSeries.update(candle);

            // Aktualizacja kafelka na g√≥rze
            const btcTag = document.getElementById('price-bitcoin');
            if (btcTag) {
                btcTag.innerText = parseFloat(kline.c).toFixed(2) + " $";
                btcTag.style.color = candle.close >= candle.open ? "#28a745" : "#dc3545";
            }
        };
        
        // Ustaw widok na koniec
        chart.timeScale().scrollToPosition(5, true);
    }

    // ==========================================
    // 2. TRYB HISTORII (COINGECKO: D≈Çugi termin)
    // ==========================================
    async function changeInterval(days, title) {
        // Wy≈ÇƒÖczamy tryb Live (zamykamy WebSocket)
        if (ws) { 
            ws.close(); 
            ws = null; 
            console.log("WebSocket zamkniƒôty - tryb historii");
        }
        
        // Zmiana UI
        document.getElementById('btn-live').className = "btn btn-outline-danger btn-sm"; // Live na szaro
        chartTitle.innerText = `Bitcoin (USD) - ${title}`;

        // Sprawdzamy Cache
        if (chartCache[days]) {
            candleSeries.setData(chartCache[days]);
            chart.timeScale().fitContent();
            return;
        }

        try {
            console.log(`Pobieram historiƒô CoinGecko dla: ${days} dni...`);
            const response = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/ohlc?vs_currency=usd&days=${days}`);
            
            if (response.status === 429) { alert("Limit CoinGecko! Czekaj."); return; }
            
            const data = await response.json();
            const formattedData = data.map(item => ({
                time: item[0] / 1000,
                open: item[1], high: item[2], low: item[3], close: item[4]
            }));

            chartCache[days] = formattedData;
            candleSeries.setData(formattedData);
            chart.timeScale().fitContent();
            
        } catch (error) {
            console.error(error);
        }
    }

    // ==========================================
    // KAFELKI (RESZTA WALUT)
    // ==========================================
    function fetchOtherPrices() {
        const priceTags = document.querySelectorAll('.price-tag');
        let symbols = [];
        priceTags.forEach(tag => {
            if (tag.dataset.symbol.toLowerCase() !== 'bitcoin') {
                symbols.push(tag.dataset.symbol.toLowerCase());
            }
        });

        if (symbols.length === 0) return;

        fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbols.join(',')}&vs_currencies=usd`)
            .then(res => res.json())
            .then(data => {
                priceTags.forEach(tag => {
                    const s = tag.dataset.symbol.toLowerCase(); 
                    if (data[s]) tag.innerText = data[s].usd + " $";
                });
            }).catch(e => {});
    }

    // START
    window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth }));
    
    // Na start: Tryb LIVE (1 minuta)
    switchToLive();
    
    // Reszta walut co 45s
    setInterval(fetchOtherPrices, 45000);
    fetchOtherPrices();

</script>
{% endblock %}